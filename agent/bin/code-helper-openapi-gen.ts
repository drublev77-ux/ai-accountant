#!/usr/bin/env tsx

import { createClient } from '@hey-api/openapi-ts';
import { mkdir, readdir, readFile, writeFile } from 'node:fs/promises';
import { join } from 'node:path';

async function main() {
  const inputDir = join('spec', 'platform-sdk', 'api-schemas');
  const outputDirBase = join('src', 'sdk', 'api-clients');

  const names = (await readdir(inputDir).catch(() => [])).filter(file => file.endsWith('.json')).map(x => x.slice(0, -5));
  if (names.length === 0) {
    console.log('No API schemas found in the input directory');
    process.exit(0);
  }

  for (const name of names) {
    console.log(`Generating API client for ${name}`);

    const inputJsonPath = join(inputDir, `${name}.json`);
    const inputJsonContent = await readFile(inputJsonPath, 'utf-8').catch(() => '');
    if (!inputJsonContent) {
      console.log('[warning] json file is empty: ' + inputJsonPath)
      continue;
    }

    const outputDir = join(outputDirBase, name);
    await mkdir(outputDirBase, { recursive: true });
    await createClient({
      input: inputJsonPath,
      output: outputDir,
      interactive: false,
      plugins: [
        { name: '@hey-api/client-fetch' }
      ]
    });

    // patch the client.gen.ts
    const clientGenFile = join(outputDir, 'client.gen.ts');
    let clientGenContent = await readFile(clientGenFile, 'utf-8');
    clientGenContent = `import { platformRequest } from '@/sdk/core/request';\n${clientGenContent}`;
    clientGenContent = clientGenContent.replace(/baseUrl:/g, 'fetch: platformRequest,\nbaseUrl:');
    await writeFile(clientGenFile, clientGenContent);

    // dumb patch: remove "// @ts-expect-error" from ./client/client.gen.ts
    try {
      const badFilePath = join(outputDir, 'client', 'client.gen.ts');
      const badFileContent = await readFile(badFilePath, 'utf-8');
      const fixedFileContent = badFileContent.replace(/@ts-expect-error/gm, '');
      await writeFile(badFilePath, fixedFileContent);
    } catch (error) {
      console.error(`Failed to patch client/client.gen.ts: ${error}`);
    }

    // patch the types.gen.ts
    // add simple example of exported methods in sdk.gen.ts

    const sdkGenFile = join(outputDir, 'sdk.gen.ts');
    const sdkGenContent = await readFile(sdkGenFile, 'utf-8');
    const sdkExportedNames = Array.from(sdkGenContent.matchAll(/export const (\w+).+?<(\w+)Data/g)).map(x => {
      let comment = ''
      if (sdkGenContent.slice(x.index - 5, x.index).trim().endsWith('*/')) {
        const starts = sdkGenContent.lastIndexOf('\n/*', x.index);
        comment = sdkGenContent.slice(starts, x.index).trim();
      }

      return ({
        comment,
        fnName: x[1],
        typePrefix: x[2],
      });
    });

    const typesGenFile = join(outputDir, 'types.gen.ts');
    const newContentParts = [
      `// Use these request functions from "./sdk.gen.ts" or "./index.ts":`,
      '//',
      ...sdkExportedNames.map(x => [
        `${x.comment.replace(/^/gm, '//   ')}`,
        `//   export function ${x.fnName}(opts: ${x.typePrefix}Data): Promise<{`,
        `//     error?: ${x.typePrefix}Errors[keyof ${x.typePrefix}Errors],`,
        `//     data?: ${x.typePrefix}Responses[keyof ${x.typePrefix}Responses],`,
        `//     request: Request,`,
        `//     response: Response }>;`,
      ].join('\n')),
      '//',
    ]

    if (/"default"|"example"/.test(inputJsonContent)) {
      newContentParts.push(
        '//',
        '// NOTICE: Please use default values from original openapi schema:',
        '//',
        ...inputJsonContent.split('\n').map(x => '//    ' + x),
        '//',
      )
    }

    const typesGenContent = await readFile(typesGenFile, 'utf-8');
    newContentParts.push(typesGenContent.replace(/This file is auto-generated by.+$/im, ''))
    await writeFile(typesGenFile, newContentParts.join('\n'));

  }
}

main().catch(error => {
  console.error(`Failed to generate API clients: ${error}`);
  process.exit(1);
});
